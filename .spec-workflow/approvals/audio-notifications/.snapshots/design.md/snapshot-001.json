{
  "id": "snapshot_1768277482273_u6blv95dj",
  "approvalId": "approval_1768277482268_32frw6n4c",
  "approvalTitle": "Audio Notifications - Design Document",
  "version": 1,
  "timestamp": "2026-01-13T04:11:22.273Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nAudio notifications provide real-time auditory feedback during training sessions to alert users when their heart rate deviates from target zones and when workout phases transition. This feature creates a complete biofeedback loop by allowing users to respond to guidance without visual attention to the screen, enabling safer and more natural exercise.\n\nThe implementation adds an AudioFeedbackService singleton that integrates with the existing WorkoutScreen session progress stream and BackgroundService to deliver timely, non-intrusive audio cues during active workouts.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Architecture Alignment:**\n- **Hexagonal Architecture**: Audio service acts as an adapter implementing auditory feedback port\n- **Dependency Injection**: AudioFeedbackService injected into WorkoutScreen via provider pattern\n- **Performance Requirements**: Audio trigger latency < 100ms aligns with tech.md response time goal\n- **Flutter Integration**: Uses Flutter plugin ecosystem following established pattern (flutter_background_service, permission_handler)\n\n**Technology Stack:**\n- **Dart/Flutter**: Audio service implemented in Flutter layer (not Rust core)\n- **Asset Management**: Audio files bundled via pubspec.yaml asset configuration\n- **State Management**: Audio settings persisted via SharedPreferences following ProfileService pattern\n- **Testing**: Manual E2E testing on physical device (per CLI-first development strategy)\n\n**Rationale for Flutter-layer Implementation:**\nAudio feedback is a UI concern (user notification), not core business logic. Keeping it in Flutter:\n1. Avoids FFI overhead for frequent audio triggers\n2. Leverages Flutter audio plugin ecosystem\n3. Simplifies integration with existing UI state streams\n4. Follows separation of concerns (Rust = deterministic logic, Flutter = I/O and user feedback)\n\n### Project Structure (structure.md)\n\n**Directory Organization:**\n```\nlib/\n├── src/\n│   ├── services/\n│   │   ├── audio_feedback_service.dart   # NEW: Audio playback service\n│   │   ├── profile_service.dart          # EXTEND: Add audio settings\n│   │   ├── background_service.dart       # REFERENCE: Service pattern\n│   │   └── ...\n│   ├── screens/\n│   │   ├── workout_screen.dart           # MODIFY: Integrate audio triggers\n│   │   ├── settings_screen.dart          # MODIFY: Add audio settings UI\n│   │   └── ...\n│   ├── widgets/\n│   │   └── zone_feedback.dart            # REFERENCE: Zone status integration\n│   └── models/\n│       └── user_profile.dart             # EXTEND: Add audio preference fields\n└── assets/\n    └── audio/                             # NEW: Audio asset files\n        ├── too_high.mp3\n        ├── too_low.mp3\n        └── phase_change.mp3\n```\n\n**Naming Conventions:**\n- Service: `AudioFeedbackService` (PascalCase, singleton pattern)\n- Files: `audio_feedback_service.dart` (snake_case)\n- Methods: `playZoneTooHigh()`, `playZoneTooLow()` (camelCase)\n- Assets: `too_high.mp3`, `too_low.mp3` (snake_case)\n\n**Code Organization:**\n- Max ~200 lines for AudioFeedbackService (simple playback + state)\n- Max ~50 lines added to WorkoutScreen (zone change detection + triggers)\n- Max ~100 lines added to SettingsScreen (UI controls)\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n1. **ProfileService** (`lib/src/services/profile_service.dart`)\n   - **Pattern reuse**: Singleton pattern with `getInstance()` factory\n   - **Storage reuse**: SharedPreferences persistence pattern for audio settings\n   - **Stream pattern**: Broadcast stream for settings change notifications\n   - **Extension**: Add `audioFeedbackEnabled`, `audioVolume` fields to UserProfile model\n\n2. **BackgroundService** (`lib/src/services/background_service.dart`)\n   - **Pattern reuse**: Service initialization flow (`initializeService()` before `startService()`)\n   - **Android integration**: Audio must work during foreground service (screen off)\n   - **Audio focus**: Reference Android audio focus management patterns\n\n3. **WorkoutScreen** (`lib/src/screens/workout_screen.dart`)\n   - **Integration point**: Session progress stream already provides `ApiZoneStatus` updates\n   - **State tracking**: `_zoneStatus`, `_currentPhaseName`, `_currentState` available for audio triggers\n   - **Pattern reuse**: Stream subscription pattern for real-time updates\n\n4. **ZoneFeedbackWidget** (`lib/src/widgets/zone_feedback.dart`)\n   - **Zone logic reuse**: `isInZone()`, `isTooLow()`, `isTooHigh()` helper methods\n   - **Integration reference**: Visual feedback already synchronized with zone status\n\n5. **SessionScreen** (`lib/src/screens/session_screen.dart`)\n   - **Zone calculation**: `ProfileService.getZoneForBpm(bpm)` pattern for zone determination\n   - **Stream pattern**: StreamBuilder integration with Rust API\n\n### Integration Points\n\n1. **WorkoutScreen Progress Stream** (`lib/src/screens/workout_screen.dart`)\n   - **Current behavior**: Receives `ApiSessionProgress` updates, extracts zone status\n   - **Audio integration**: Add audio triggers when `_zoneStatus` changes\n   - **Debouncing**: Track last audio time to prevent spam during zone boundary oscillation\n   - **Phase transitions**: Detect `_currentPhaseName` changes to trigger phase audio\n\n2. **UserProfile Model** (`lib/src/models/user_profile.dart`)\n   - **Current fields**: `maxHr`, `age`, `useAgeBased`, `customZones`\n   - **Extension**: Add `audioFeedbackEnabled` (bool, default: true), `audioVolume` (double, default: 0.7)\n   - **JSON serialization**: Extend `toJson()`/`fromJson()` for new fields\n\n3. **SettingsScreen** (`lib/src/screens/settings_screen.dart`)\n   - **Current structure**: Card-based settings sections (Max HR, Training Zones)\n   - **Extension**: Add \"Audio Feedback\" card with toggle and volume slider\n   - **Save flow**: Update profile via `ProfileService.saveProfile()`\n\n4. **Background Service Audio Focus** (`lib/src/services/background_service.dart`)\n   - **Coordination**: Audio must coexist with foreground notification\n   - **Android policy**: Audio service must request and handle audio focus (duck other audio)\n\n## Architecture\n\n### System Overview\n\nThe audio feedback system follows a reactive architecture where audio cues are triggered by state changes in the workout session. The AudioFeedbackService acts as a stateless adapter between workout state streams and platform audio APIs.\n\n```mermaid\ngraph TD\n    A[Rust Core - SessionProgress] -->|FRB Stream| B[WorkoutScreen]\n    B -->|Zone Status Change| C[AudioFeedbackService]\n    B -->|Phase Change| C\n    D[SettingsScreen] -->|Settings| E[ProfileService]\n    E -->|Audio Preferences| C\n    C -->|Play Audio| F[Audio Plugin]\n    F -->|Audio Focus| G[Android Audio System]\n    H[BackgroundService] -.->|Coexists| G\n```\n\n### Data Flow\n\n1. **Session Progress Updates** (every HR reading)\n   ```\n   Rust api.createSessionProgressStream()\n   → WorkoutScreen._progressSubscription\n   → Extract zoneStatus, phaseName, sessionState\n   → Compare with previous state\n   → IF changed AND session running THEN trigger audio\n   ```\n\n2. **Audio Trigger Logic** (WorkoutScreen)\n   ```\n   IF zoneStatus changed from InZone to TooLow\n      AND (now - lastAudioTime) > 5 seconds\n      AND sessionState == Running\n      AND audioEnabled\n   THEN AudioFeedbackService.playZoneTooLow()\n   ```\n\n3. **Audio Playback** (AudioFeedbackService)\n   ```\n   Load audio settings from ProfileService\n   IF audioEnabled == false THEN return\n   Request audio focus (duck other audio)\n   Play audio asset at configured volume\n   Release audio focus\n   ```\n\n4. **Settings Update** (SettingsScreen)\n   ```\n   User toggles audio or adjusts volume\n   → Update UserProfile model\n   → ProfileService.saveProfile()\n   → AudioFeedbackService reads new settings on next trigger\n   ```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: AudioFeedbackService handles only audio playback, not zone logic or state management\n- **Component Isolation**: Audio service has no dependencies on WorkoutScreen; integrated via loose coupling\n- **Service Layer Separation**: WorkoutScreen (presentation) → ProfileService (data) → AudioFeedbackService (I/O)\n- **Utility Modularity**: Audio asset preloading and debouncing logic encapsulated in service\n\n## Components and Interfaces\n\n### Component 1: AudioFeedbackService\n\n- **Purpose:** Singleton service for playing audio feedback cues during workouts\n- **Location:** `lib/src/services/audio_feedback_service.dart`\n- **Interfaces:**\n  - `Future<void> initialize()` - Preload audio assets, setup audio session\n  - `Future<void> playZoneTooHigh()` - Play \"too high\" audio cue\n  - `Future<void> playZoneTooLow()` - Play \"too low\" audio cue\n  - `Future<void> playPhaseTransition()` - Play phase change audio cue\n  - `void dispose()` - Release audio resources\n  - `static AudioFeedbackService getInstance()` - Singleton accessor\n- **Dependencies:**\n  - Audio plugin (audioplayers or just_audio, TBD in task 1)\n  - ProfileService (for audio settings)\n  - Flutter AssetBundle (for loading assets)\n- **Reuses:**\n  - ProfileService singleton pattern\n  - BackgroundService initialization pattern\n- **State:**\n  - `AudioPlayer` instance(s) for audio playback\n  - Cached audio settings (enabled, volume) from ProfileService\n  - Audio asset paths (constants)\n\n### Component 2: WorkoutScreen Audio Integration\n\n- **Purpose:** Trigger audio feedback based on session progress state changes\n- **Location:** `lib/src/screens/workout_screen.dart` (modifications)\n- **Interfaces:** (internal, no new public API)\n  - `_onProgressUpdate(ApiSessionProgress progress)` - Enhanced to detect changes and trigger audio\n  - `_triggerZoneAudio(ApiZoneStatus status)` - Debounced audio trigger\n  - `_triggerPhaseAudio(String phaseName)` - Phase transition audio\n- **Dependencies:**\n  - AudioFeedbackService.getInstance()\n  - Existing session progress stream\n  - DateTime.now() for debouncing\n- **Reuses:**\n  - Existing `_progressSubscription` stream handling\n  - Existing zone status helpers from ZoneFeedbackWidget\n- **State:**\n  - `_lastAudioTime` - DateTime of last audio trigger (debouncing)\n  - `_lastZoneStatus` - Previous zone status (change detection)\n  - `_lastPhaseName` - Previous phase name (transition detection)\n\n### Component 3: SettingsScreen Audio Controls\n\n- **Purpose:** UI for enabling/disabling audio feedback and adjusting volume\n- **Location:** `lib/src/screens/settings_screen.dart` (modifications)\n- **Interfaces:** (UI, no public API)\n  - Audio feedback toggle switch\n  - Volume slider (0.0-1.0 with step 0.1)\n  - Save button triggers profile update\n- **Dependencies:**\n  - ProfileService.getInstance()\n  - UserProfile model (extended with audio fields)\n- **Reuses:**\n  - Existing settings card layout\n  - Existing profile save flow\n- **State:**\n  - Local widget state for toggle and slider (synced with UserProfile)\n\n### Component 4: UserProfile Model Extensions\n\n- **Purpose:** Persist audio feedback preferences across app restarts\n- **Location:** `lib/src/models/user_profile.dart` (modifications)\n- **Interfaces:**\n  - `bool audioFeedbackEnabled` - Getter/setter (default: true)\n  - `double audioVolume` - Getter/setter (default: 0.7, range: 0.0-1.0)\n  - `toJson()` / `fromJson()` - Extended serialization\n- **Dependencies:**\n  - None (data model)\n- **Reuses:**\n  - Existing JSON serialization pattern\n  - Existing validation pattern (e.g., maxHr bounds checking)\n- **State:**\n  - `bool _audioFeedbackEnabled`\n  - `double _audioVolume` (validated: 0.0-1.0)\n\n### Component 5: Audio Asset Files\n\n- **Purpose:** Provide distinct, non-intrusive audio cues for feedback\n- **Location:** `assets/audio/` directory\n- **Files:**\n  - `too_high.mp3` - Played when HR exceeds target zone upper bound\n  - `too_low.mp3` - Played when HR falls below target zone lower bound\n  - `phase_change.mp3` - Played when workout phase transitions\n- **Requirements:**\n  - File size < 100KB each (fast loading)\n  - Duration ~500ms-1s (brief, non-intrusive)\n  - Distinct tones (easily distinguishable)\n  - Appropriate for exercise context (motivational, not alarming)\n- **Asset Registration:**\n  - Added to `pubspec.yaml` flutter assets section\n  - Verified in release build\n\n## Data Models\n\n### Extended UserProfile Model\n\n```dart\nclass UserProfile {\n  // Existing fields\n  int _maxHr;\n  int? _age;\n  bool _useAgeBased;\n  CustomZones? _customZones;\n\n  // NEW: Audio feedback fields\n  bool _audioFeedbackEnabled;  // Default: true\n  double _audioVolume;         // Default: 0.7, Range: 0.0-1.0\n\n  // Getters\n  bool get audioFeedbackEnabled => _audioFeedbackEnabled;\n  double get audioVolume => _audioVolume;\n\n  // Setters (with validation)\n  set audioFeedbackEnabled(bool value) {\n    _audioFeedbackEnabled = value;\n  }\n\n  set audioVolume(double value) {\n    if (value < 0.0 || value > 1.0) {\n      throw ArgumentError('audioVolume must be between 0.0 and 1.0');\n    }\n    _audioVolume = value;\n  }\n\n  // JSON serialization (extended)\n  Map<String, dynamic> toJson() => {\n    'maxHr': _maxHr,\n    'age': _age,\n    'useAgeBased': _useAgeBased,\n    'customZones': _customZones?.toJson(),\n    'audioFeedbackEnabled': _audioFeedbackEnabled,  // NEW\n    'audioVolume': _audioVolume,                    // NEW\n  };\n\n  factory UserProfile.fromJson(Map<String, dynamic> json) => UserProfile(\n    maxHr: json['maxHr'] as int,\n    age: json['age'] as int?,\n    useAgeBased: json['useAgeBased'] as bool,\n    customZones: json['customZones'] != null\n        ? CustomZones.fromJson(json['customZones'])\n        : null,\n    audioFeedbackEnabled: json['audioFeedbackEnabled'] as bool? ?? true,  // NEW (default true)\n    audioVolume: (json['audioVolume'] as num?)?.toDouble() ?? 0.7,        // NEW (default 0.7)\n  );\n}\n```\n\n### AudioFeedbackService State\n\n```dart\nclass AudioFeedbackService {\n  static AudioFeedbackService? _instance;\n\n  AudioPlayer? _player;  // Plugin-specific player instance\n  bool _initialized = false;\n\n  // Audio asset paths (constants)\n  static const String _assetTooHigh = 'assets/audio/too_high.mp3';\n  static const String _assetTooLow = 'assets/audio/too_low.mp3';\n  static const String _assetPhaseChange = 'assets/audio/phase_change.mp3';\n\n  // Singleton accessor\n  static AudioFeedbackService getInstance() {\n    _instance ??= AudioFeedbackService._internal();\n    return _instance!;\n  }\n\n  // Private constructor\n  AudioFeedbackService._internal();\n\n  // Methods (see Component 1 interfaces)\n}\n```\n\n### WorkoutScreen Debouncing State\n\n```dart\nclass _WorkoutScreenState extends State<WorkoutScreen> {\n  // Existing state\n  ApiSessionProgress? _currentProgress;\n  ApiZoneStatus? _zoneStatus;\n  String? _currentPhaseName;\n  String _currentState = 'Unknown';\n\n  // NEW: Audio feedback state\n  DateTime? _lastAudioTime;         // For debouncing zone audio\n  ApiZoneStatus? _lastZoneStatus;   // For change detection\n  String? _lastPhaseName;           // For phase transition detection\n\n  static const Duration _audioDebounceInterval = Duration(seconds: 5);\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Audio Package Initialization Failure**\n   - **Handling:** Log error via tracing, set `_initialized = false`, return early from play methods\n   - **User Impact:** No audio feedback (silent failure), visual feedback still works\n   - **Rationale:** Audio is enhancement, not critical feature; visual feedback provides fallback\n\n2. **Audio Asset Missing or Failed to Load**\n   - **Handling:** Catch asset loading exception, log error with file path, skip audio playback\n   - **User Impact:** Specific audio cue missing, other cues may still work\n   - **Recovery:** Check pubspec.yaml asset registration, verify file paths\n\n3. **Audio Focus Request Denied (Android)**\n   - **Handling:** Attempt playback anyway (transient focus), log warning\n   - **User Impact:** Audio may duck or be silenced by other apps (e.g., music player)\n   - **Rationale:** Defer to Android audio policy, user has implicit control via other app\n\n4. **Settings Load Failure (SharedPreferences)**\n   - **Handling:** ProfileService handles this; AudioFeedbackService uses safe defaults (enabled=true, volume=0.7)\n   - **User Impact:** Audio plays with default settings until preferences load\n   - **Rationale:** Fail-safe defaults ensure audio works out-of-box\n\n5. **Audio Playback During Paused Session**\n   - **Handling:** Check `_currentState == 'Running'` before triggering audio\n   - **User Impact:** No audio when session is paused (correct behavior)\n   - **Prevention:** Gate audio triggers on session state\n\n6. **Excessive Audio Triggering (Zone Boundary Oscillation)**\n   - **Handling:** Debounce audio triggers with 5-second minimum interval\n   - **User Impact:** Maximum one audio cue per 5 seconds (prevents spam)\n   - **Implementation:** Track `_lastAudioTime`, skip trigger if within interval\n\n## Testing Strategy\n\n### Unit Testing\n\n**AudioFeedbackService:**\n- Mock audio player plugin\n- Test `initialize()` preloads assets correctly\n- Test `playZoneTooHigh()` calls player with correct asset and volume\n- Test disabled state (audioEnabled=false) prevents playback\n- Test volume scaling applied correctly (0.0-1.0)\n\n**UserProfile Model Extensions:**\n- Test JSON serialization with audio fields\n- Test backward compatibility (loading old profiles without audio fields)\n- Test validation (audioVolume bounds checking)\n- Test default values (enabled=true, volume=0.7)\n\n### Integration Testing\n\n**WorkoutScreen Audio Integration:**\n- Mock AudioFeedbackService\n- Simulate zone status changes in progress stream\n- Verify audio triggered on zone deviation (InZone → TooLow, InZone → TooHigh)\n- Verify audio NOT triggered on same status (TooLow → TooLow)\n- Verify debouncing (multiple triggers within 5s → single audio)\n- Verify session state gating (audio only when Running, not Paused)\n- Verify phase transition detection (phaseName change → phase audio)\n\n**SettingsScreen Persistence:**\n- Mock ProfileService\n- Toggle audio setting, verify profile updated and saved\n- Adjust volume, verify profile updated and saved\n- Reload settings screen, verify values restored from profile\n\n### End-to-End Testing\n\n**Physical Device Testing (Android):**\n1. **Basic Audio Playback:**\n   - Start workout, go below zone → Hear \"too low\" audio\n   - Increase intensity, go above zone → Hear \"too high\" audio\n   - Return to zone → No audio (only deviation triggers audio)\n   - Phase transition → Hear phase change audio\n\n2. **Background Service Integration:**\n   - Start workout, lock screen → Audio still plays\n   - Verify audio focus: Play music, trigger zone audio → Music ducks, audio plays\n   - Unlock screen → Visual and audio feedback synchronized\n\n3. **Settings Persistence:**\n   - Disable audio in settings → No audio during workout\n   - Re-enable audio → Audio plays again\n   - Adjust volume to 0.3 → Audio quieter\n   - Adjust volume to 1.0 → Audio louder\n   - Kill app, restart → Settings restored\n\n4. **Debouncing:**\n   - Hover at zone boundary (oscillating in/out) → Max one audio per 5 seconds\n   - Verify no audio spam during HR noise/artifacts\n\n5. **Session Control:**\n   - Pause workout → No audio during pause\n   - Resume workout → Audio resumes on zone changes\n   - Stop workout → No audio after stop\n\n6. **Battery Impact:**\n   - Run 60-minute workout with audio enabled\n   - Compare battery drain vs without audio (should be negligible)\n\n**Test Devices:**\n- Primary: Physical Android device (API 26+)\n- Secondary: Linux CLI (no audio support, but verify no crashes)\n\n**Success Criteria:**\n- Audio plays reliably within 100ms of trigger\n- Audio works with screen off (foreground service)\n- Settings persist across app restarts\n- No audio spam during zone oscillation\n- Battery impact < 2% over 60 minutes\n- Graceful degradation if audio unavailable\n",
  "fileStats": {
    "size": 20011,
    "lines": 491,
    "lastModified": "2026-01-13T04:11:17.399Z"
  },
  "comments": []
}
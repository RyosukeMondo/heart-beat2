# Tarpaulin Configuration Guide

**Date**: 2026-01-13
**Configuration File**: `rust/tarpaulin.toml`

## Overview

The tarpaulin configuration enforces the 80% minimum coverage requirement specified in `product.md`. It excludes generated code and the CLI binary from coverage calculations to focus metrics on testable business logic.

## Configuration Details

### Coverage Threshold
- **Threshold**: 80% minimum coverage
- **Enforcement**: CI builds will fail if coverage falls below 80%
- **Metric**: Line coverage (branch coverage can be added later if needed)

### Excluded Files

The following files are excluded from coverage calculations:

1. **`src/frb_generated.rs`** (2498 lines)
   - Auto-generated by flutter_rust_bridge
   - Not meaningful to test

2. **`src/bin/cli.rs`** (845 lines)
   - CLI binary is integration-tested separately
   - Difficult to unit test as it's primarily UI/UX code
   - Serves as a thin wrapper around the library

### Testable Code Baseline

- **Total lines**: 5122
- **Excluded lines**: 3343 (2498 + 845)
- **Testable lines**: 1779
- **Current coverage**: 44.52% (792/1779 lines)
- **Target coverage**: 80% (1423/1779 lines)
- **Lines needed**: 631 additional lines

## Usage

### Local Development

Run coverage with the configuration:

```bash
cd rust
cargo tarpaulin --config tarpaulin.toml
```

This will:
- Run all tests with all features enabled
- Generate HTML report: `coverage/tarpaulin-report.html`
- Generate XML report: `coverage/cobertura.xml` (for CI)
- Exit with error if coverage < 80%

### Skip Clean (Faster Reruns)

For faster reruns when code hasn't changed:

```bash
cargo tarpaulin --config tarpaulin.toml --skip-clean
```

### CI Integration

The CI workflow will use this configuration to:
1. Run coverage on every PR
2. Fail the build if coverage < 80%
3. Upload coverage reports as artifacts
4. (Optional) Publish to Codecov or similar service

## Output Files

### HTML Report
- **Path**: `rust/coverage/tarpaulin-report.html`
- **Purpose**: Local development review
- **Features**: Line-by-line coverage highlighting, module summaries

### XML Report (Cobertura)
- **Path**: `rust/coverage/cobertura.xml`
- **Purpose**: CI integration, Codecov upload
- **Format**: Standard Cobertura XML format

## Configuration Options

The `tarpaulin.toml` file uses the following options:

| Option | Value | Purpose |
|--------|-------|---------|
| `fail-under` | 80.0 | Minimum coverage threshold |
| `out` | ["Xml", "Html"] | Output formats |
| `output-dir` | "coverage/" | Report directory |
| `exclude-files` | ["src/frb_generated.rs", "src/bin/cli.rs"] | Files to exclude |
| `all-features` | true | Test with all features |
| `timeout` | "120s" | Test timeout (for async tests) |

## Verifying Configuration

To verify the configuration is working correctly:

```bash
cargo tarpaulin --config tarpaulin.toml --skip-clean 2>&1 | tail -30
```

Expected output should show:
- ✅ Excluded files not counted
- ✅ Total testable lines: 1779
- ✅ Coverage percentage: X.XX%
- ✅ Error if coverage < 80%: "Coverage is below the failure threshold"

## Next Steps

After creating this configuration (Task 3), the remaining tasks are:

1. **Task 4**: Identify specific modules/functions below 80% coverage
2. **Tasks 5-8**: Add tests to reach 80% coverage:
   - Domain layer gaps
   - Adapter layer gaps
   - State machine gaps
   - Scheduler/executor gaps
3. **Task 9**: Update CI workflow to use this configuration
4. **Task 10**: Add coverage badge to README
5. **Task 11**: Verify overall coverage >= 80%

## References

- Tarpaulin Documentation: https://github.com/xd009642/tarpaulin
- Configuration Format: https://github.com/xd009642/tarpaulin/blob/develop/README.md
- Product Requirements: `product.md` (80% coverage requirement)
